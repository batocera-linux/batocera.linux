#!/bin/bash

mkdir -p "/var/log"
mkdir -p "/userdata/system/logs"

display_log="/userdata/system/logs/display.log"
nvidia_log="/var/log/nvidia.log"
amd_log="/var/log/amd.log"
intel_log="/var/log/intel.log"

# Function to find the actual GPU which has a display connection
find_connected_gpu() {
    local -a gpu_list=("$@")
    local selected_pci_id=""
    
    for gpu_entry in "${gpu_list[@]}"; do
        local pci_id_full=$(echo "$gpu_entry" | awk -F ' ' '{print $1}')
        local drm_card=""

        for card_path in /sys/class/drm/card*; do
            if readlink -f "$card_path/device" | grep -q "$pci_id_full"; then
                drm_card=$(basename "$card_path")
                break
            fi
        done

        if [ -n "$drm_card" ]; then
            for connector_status in /sys/class/drm/"$drm_card"/*-*/status; do
                if [ -f "$connector_status" ] && [ "$(cat "$connector_status")" = "connected" ]; then
                    selected_pci_id="$pci_id_full"
                    echo "$selected_pci_id"
                    return 0
                fi
            done
        fi
    done

    echo ""
    return 1
}

case "$1" in
  start)
    # Check if there are two (or more) GPUs in the system
    gpu_count=$(lspci -nn | grep -E "(VGA|3D|Display controller)" | wc -l)
    
    # Initialize state flags
    nvidia_conditions_met=false
    amd_conditions_met=false

    if [ "$gpu_count" -ge 2 ]; then
        splash_set=$(batocera-settings-get splash.screen.enabled)
        if [ "$splash_set" = "1" ]; then
            echo "Multiple GPUs detected in the system ($gpu_count)" >> "$display_log"
        else
            echo "Multiple GPUs detected in the system ($gpu_count)" > "$display_log"
        fi
        echo "Setting best primary GPU..." >> "$display_log"
        
        # Check for NVIDIA GPUs
        nvidia_prime=$(/usr/bin/batocera-settings-get -f /boot/batocera-boot.conf nvidia-prime)
        if [ "$nvidia_prime" = "false" ]; then
            echo "'nvidia-prime' manually set to false, skipping checks" >> "$nvidia_log"
        else
            gpu_name=$(lspci -nn | grep -iE "nvidia" | grep -iE "VGA|3D|Display controller" | head -n 1)
            if [ -n "$gpu_name" ] || [ "$nvidia_prime" = "true" ]; then
                echo "" > "/var/tmp/nvidia.prime"
                echo "Using $gpu_name as the primary GPU" >> "$nvidia_log"
                echo "$gpu_name is the primary GPU" >> "$display_log"
                nvidia_conditions_met=true
            fi
        fi

        # Check for AMD/ATI GPUs
        if [ "$nvidia_conditions_met" = "false" ]; then
            radeon_prime=$(/usr/bin/batocera-settings-get -f /boot/batocera-boot.conf radeon-prime)
            if [ "$radeon_prime" = "false" ]; then
                echo "'radeon-prime' manually set to false, skipping checks" >> "$amd_log"
            else
                mapfile -t all_amd_gpus < <(lspci -nn | grep -iE "AMD/ATI" | grep -iE "VGA|3D|Display controller")
                amd_count=${#all_amd_gpus[@]}
                gpu_name=""
                
                if [ "$amd_count" -eq 0 ]; then
                    echo "No AMD/ATI GPU found." >> "$amd_log"
                elif [ "$amd_count" -eq 1 ]; then
                    gpu_name="${all_amd_gpus[0]}"
                    echo "Found a single AMD/ATI GPU: $gpu_name" >> "$amd_log"
                elif [ "$amd_count" -ge 2 ]; then
                    connected_pci_id=$(find_connected_gpu "${all_amd_gpus[@]}")
                    
                    if [ -n "$connected_pci_id" ]; then
                        gpu_entry_index=0
                        for i in "${!all_amd_gpus[@]}"; do
                            if echo "${all_amd_gpus[$i]}" | grep -q "$connected_pci_id"; then
                                gpu_entry_index=$i
                                break
                            fi
                        done
                        gpu_name="${all_amd_gpus[$gpu_entry_index]}"
                        echo "Found $amd_count AMD/ATI GPUs. Selecting connected GPU: $gpu_name" >> "$amd_log"
                    else
                        echo "Found $amd_count AMD/ATI GPUs. No connected monitor found. Selecting second entry for PRIME." >> "$amd_log"
                        printf "    - %s\n" "${all_amd_gpus[@]}" >> "$amd_log"
                        gpu_name="${all_amd_gpus[1]}"
                        echo "Setting AMD/ATI Prime to use GPU: $gpu_name" >> "$amd_log"
                    fi
                fi
                
                if [ -n "$gpu_name" ]; then
                    # Get the pci number for prime.
                    formatted_info=$(echo "$gpu_name" | awk -F ' ' '{print $1}' | sed -e 's/:/_/g' -e 's/\./_/' -e 's/^/pci-0000_/')
                    echo $formatted_info > "/var/tmp/amd.prime"
                    echo "Setting Prime ID: $formatted_info" >> "$amd_log"
                    echo "$gpu_name is the primary GPU" >> "$display_log"
                    amd_conditions_met=true
                elif [ "$radeon_prime" = "true" ]; then
                    # Handle edge case where the user forced prime=true
                    echo "Warning: 'radeon-prime=true' is set, but no suitable AMD/ATI GPU was found." >> "$amd_log"
                fi
            fi
        fi

        # Check for Intel Discrete GPUs (Arc/Xe)
        if [ "$nvidia_conditions_met" = "false" ] && [ "$amd_conditions_met" = "false" ]; then
            intel_prime=$(/usr/bin/batocera-settings-get -f /boot/batocera-boot.conf intel-prime)
            
            if [ "$intel_prime" = "false" ]; then
                echo "'intel-prime' manually set to false, skipping checks" >> "$intel_log"
            else
                mapfile -t all_intel_gpus < <(lspci -nn | grep -iE "Intel" | grep -iE "VGA|3D|Display controller")
                intel_count=${#all_intel_gpus[@]}
                gpu_name=""

                if [ "$intel_count" -ge 2 ]; then
                    connected_pci_id=$(find_connected_gpu "${all_intel_gpus[@]}")

                    if [ -n "$connected_pci_id" ]; then
                        gpu_entry_index=0
                        for i in "${!all_intel_gpus[@]}"; do
                            if echo "${all_intel_gpus[$i]}" | grep -q "$connected_pci_id"; then
                                gpu_entry_index=$i
                                break
                            fi
                        done
                        gpu_name="${all_intel_gpus[$gpu_entry_index]}"
                        echo "Found multiple Intel GPUs ($intel_count). Selecting connected GPU: $gpu_name" >> "$intel_log"
                    else
                        echo "Found multiple Intel GPUs ($intel_count). No connected monitor found. Selecting the second entry for PRIME." >> "$intel_log"
                        printf "    - %s\n" "${all_intel_gpus[@]}" >> "$intel_log"
                        gpu_name="${all_intel_gpus[1]}"
                    fi
                elif [ "$intel_count" -eq 1 ]; then
                    echo "Only one Intel GPU found (Integrated). No PRIME action taken unless forced." >> "$intel_log"
                fi

                if [ -n "$gpu_name" ]; then
                    formatted_info=$(echo "$gpu_name" | awk -F ' ' '{print $1}' | sed -e 's/:/_/g' -e 's/\./_/' -e 's/^/pci-0000_/')
                    
                    echo $formatted_info > "/var/tmp/intel.prime"
                    
                    echo "Setting Intel Prime ID: $formatted_info" >> "$intel_log"
                    echo "$gpu_name is the primary GPU" >> "$display_log"
                fi
            fi
        fi

    else
        echo "Only one GPU detected in the system" >> "$display_log"
    fi
    ;;
  stop)
    # Cleanup tmp files on stop
    rm -f /var/tmp/nvidia.prime
    rm -f /var/tmp/amd.prime
    rm -f /var/tmp/intel.prime
    ;;
  *)
    echo "Usage: $0 {start|stop}"
    exit 1
    ;;
esac

exit 0
