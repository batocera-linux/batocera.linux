#!/bin/sh

### choose configuration file
BATOCONF="/userdata/system/batocera.conf"
BOOTCONF="/boot/batocera-boot.conf"

# if /userdata is not yet available
if ! [ -f "$BATOCONF" ]; then
    # use the boot version of the file
    BATOCONF="$BOOTCONF"
fi
### #### ###

# configure wifi files, always
batocera_wifi_configure() {
    X=$1

    settings_hide=false; settings_name="${X}"
    [ "$X" = "1" ] && { X=; settings_name=default; }
    [ "$X" = ".hidden" ] && { settings_name=hidden_AP; settings_hide=true; }
    
    settings_ssid="$(/usr/bin/batocera-settings-get -f "$BATOCONF" wifi${X}.ssid)"
    settings_key="$(/usr/bin/batocera-settings-get -f "$BATOCONF" wifi${X}.key)"
    settings_file="/var/lib/connman/batocera_wifi${X}.config"

    if [ -n "$settings_ssid" ];then
        mkdir -p "/var/lib/connman"
        cat > "${settings_file}" <<-_EOF_
		[global]
		Name=batocera
		[service_batocera_${settings_name}]
		Type=wifi
		Name=${settings_ssid}
		Hidden=${settings_hide}
		Passphrase=${settings_key}
	_EOF_
    fi
}

wifi_configure_all() {
    for i in 1 2 3 .hidden
    do
	batocera_wifi_configure $i
	ret=$?
    done
}

wifi_enable() {
    # WLAN enabled?
    settingsWlan="$(/usr/bin/batocera-settings-get -f "$BATOCONF" wifi.enabled)"
    if [ "$settingsWlan" != "1" ];then
	connmanctl disable wifi 2>/dev/null
	return
    fi

    connmanctl enable wifi 2>/dev/null
    connmanctl scan   wifi 2>/dev/null
}

case "$1" in
	start)
	        wifi_configure_all
	        printf "Starting connman: "
		start-stop-daemon -S -q -m -b -p /var/run/connmand.pid --exec /usr/sbin/connmand -- -n

		# wait connmann is started. otherwise, S10wifi is unable to execute connmanctl commands
		N=0
		connmanctl state 2>/dev/null | grep -qE '^[ ]*State[ ]='
		while test $? -ne 0 -a $N -lt 5 # 5 tries
		do
		    N=$((N+1))
		    sleep 1
		    connmanctl state 2>/dev/null | grep -qE '^[ ]*State[ ]='
		done

		# can be done detached
		wifi_enable &

		echo "done."
		;;
	stop)
		printf "Stopping connman: "
		start-stop-daemon -K -q -p /var/run/connmand.pid
		echo "done."
		;;
	restart)
		$0 stop
		sleep 1
		$0 start
		;;
	*)
		echo "usage: $0 {start|stop|restart}"
		;;
esac
