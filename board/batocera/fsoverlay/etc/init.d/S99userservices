#!/bin/bash

# custom.sh : deprecated
if test -e "/userdata/system/custom.sh"; then
    #bash interpreter executes scripts without x-flag e.g. for vFAT
    bash /userdata/system/custom.sh $1 &
fi

enabled_services="$(/usr/bin/batocera-settings-get system.services)"

if test -n "${enabled_services}"
then
    for SERVICE in ${enabled_services}
    do
	export __SERVICE__${SERVICE}=1
    done
fi

# user services
find -L /userdata/system/services -type f |
    while read SERVICE
    do
    BASE_SERVICE=${SERVICE##*/}
    if [[ "$BASE_SERVICE" == ${BASE_SERVICE//[^0-9A-Za-z_]/} && ${BASE_SERVICE:0:1} =~ ^[[:alpha:]] ]]; then
        SRVVAR=__SERVICE__${BASE_SERVICE}
        if test "${!SRVVAR}" = 1; then
            bash "${SERVICE}" "${1}" &
            echo "User Service: ${BASE_SERVICE} - ${1} condition [ok] - service enabled"
        else
            echo "User Service: ${BASE_SERVICE} - ${1} condition [ok] - service disabled"
        fi
    else
        echo "User Service: ${BASE_SERVICE} - ${1} condition [ko] - invalid filename"
    fi
    done

# system user services
find -L /usr/share/batocera/services -type f |
    while read SERVICE
    do
    BASE_SERVICE=${SERVICE##*/}
    SRVVAR=__SERVICE__${BASE_SERVICE}
    if test "${!SRVVAR}" = 1; then
        bash "${SERVICE}" "${1}" &
        echo "System Service: ${BASE_SERVICE} - ${1} condition [ok] - service enabled"
    else
        echo "System Service: ${BASE_SERVICE} - ${1} condition [ok] - service disabled"
    fi
    done

# wait scripts to finish on stop condition, shutdown can happen
test "${1}" = "stop" && wait
