From b887acd578a32e63cfc19749278d06ba94563755 Mon Sep 17 00:00:00 2001
From: Ntemis <ierokipides.dem@gmail.com>
Date: Fri, 22 May 2020 16:01:39 +0300
Subject: [PATCH] RK3288: Fix chocking cpu freqs

---
 arch/arm/boot/dts/rk3288-miniarm.dts | 55 +------------------
 arch/arm/boot/dts/rk3288-miqi.dts    | 53 ------------------
 drivers/cpufreq/rockchip-cpufreq.c   | 80 ++++++++++++++++++++++++++++
 3 files changed, 81 insertions(+), 107 deletions(-)

diff --git a/arch/arm/boot/dts/rk3288-miniarm.dts b/arch/arm/boot/dts/rk3288-miniarm.dts
index 7b9bfbd82..1b6fd705f 100644
--- a/arch/arm/boot/dts/rk3288-miniarm.dts
+++ b/arch/arm/boot/dts/rk3288-miniarm.dts
@@ -235,59 +235,6 @@
 	cpu0-supply = <&vdd_cpu>;
 };
 
-&cpu0_opp_table {
-	rockchip,max-volt = <1500000>;
-	/* overclock frequencies below - use governors to set desired freq */
-	opp-1896000000 {
-		opp-hz = /bits/ 64 <1896000000>;
-		opp-microvolt = <1425000>;
-	};
-	opp-1920000000 {
-		opp-hz = /bits/ 64 <1920000000>;
-		opp-microvolt = <1425000>;
-	};
-	opp-1992000000 {
-		opp-hz = /bits/ 64 <1992000000>;
-		opp-microvolt = <1450000>;
-	};
-	opp-2016000000 {
-		opp-hz = /bits/ 64 <2016000000>;
-		opp-microvolt = <1475000>;
-	};
-	opp-2040000000 {
-		opp-hz = /bits/ 64 <2040000000>;
-		opp-microvolt = <1475000>;
-	};
-	opp-2064000000 {
-		opp-hz = /bits/ 64 <2064000000>;
-		opp-microvolt = <1475000>;
-	};
-	opp-2088000000 {
-		opp-hz = /bits/ 64 <2088000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2112000000 {
-		opp-hz = /bits/ 64 <2112000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2136000000 {
-		opp-hz = /bits/ 64 <2136000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2160000000 {
-		opp-hz = /bits/ 64 <2160000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2184000000 {
-		opp-hz = /bits/ 64 <2184000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2208000000 {
-		opp-hz = /bits/ 64 <2208000000>;
-		opp-microvolt = <1500000>;
-	};
-};
-
 &emmc {
 	bus-width = <8>;
 	cap-mmc-highspeed;
@@ -381,7 +328,7 @@
 				regulator-always-on;
 				regulator-boot-on;
 				regulator-min-microvolt = <750000>;
-				regulator-max-microvolt = <1500000>;
+				regulator-max-microvolt = <1450000>;
 				regulator-name = "vdd_arm";
 				regulator-ramp-delay = <6000>;
 				regulator-state-mem {
diff --git a/arch/arm/boot/dts/rk3288-miqi.dts b/arch/arm/boot/dts/rk3288-miqi.dts
index 8e287a6d2..feff11fcb 100644
--- a/arch/arm/boot/dts/rk3288-miqi.dts
+++ b/arch/arm/boot/dts/rk3288-miqi.dts
@@ -190,59 +190,6 @@
 	cpu0-supply = <&vdd_cpu>;
 };
 
-&cpu0_opp_table {
-	rockchip,max-volt = <1500000>;
-	/* overclock frequencies below - use governors to set desired freq */
-	opp-1896000000 {
-		opp-hz = /bits/ 64 <1896000000>;
-		opp-microvolt = <1425000>;
-	};
-	opp-1920000000 {
-		opp-hz = /bits/ 64 <1920000000>;
-		opp-microvolt = <1425000>;
-	};
-	opp-1992000000 {
-		opp-hz = /bits/ 64 <1992000000>;
-		opp-microvolt = <1450000>;
-	};
-	opp-2016000000 {
-		opp-hz = /bits/ 64 <2016000000>;
-		opp-microvolt = <1475000>;
-	};
-	opp-2040000000 {
-		opp-hz = /bits/ 64 <2040000000>;
-		opp-microvolt = <1475000>;
-	};
-	opp-2064000000 {
-		opp-hz = /bits/ 64 <2064000000>;
-		opp-microvolt = <1475000>;
-	};
-	opp-2088000000 {
-		opp-hz = /bits/ 64 <2088000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2112000000 {
-		opp-hz = /bits/ 64 <2112000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2136000000 {
-		opp-hz = /bits/ 64 <2136000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2160000000 {
-		opp-hz = /bits/ 64 <2160000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2184000000 {
-		opp-hz = /bits/ 64 <2184000000>;
-		opp-microvolt = <1500000>;
-	};
-	opp-2208000000 {
-		opp-hz = /bits/ 64 <2208000000>;
-		opp-microvolt = <1500000>;
-	};
-};
-
 &gpu {
 	status = "okay";
 	mali-supply = <&vdd_gpu>;
diff --git a/drivers/cpufreq/rockchip-cpufreq.c b/drivers/cpufreq/rockchip-cpufreq.c
index 754989fd8..548ca159b 100644
--- a/drivers/cpufreq/rockchip-cpufreq.c
+++ b/drivers/cpufreq/rockchip-cpufreq.c
@@ -74,11 +74,91 @@ static int px30_get_soc_info(struct device *dev, struct device_node *np,
 	return ret;
 }
 
+static int rk3288_get_soc_info(struct device *dev, struct device_node *np,
+			       int *bin, int *process)
+{
+	int ret = 0, value = -EINVAL;
+	char *name;
+
+	if (!bin)
+		goto next;
+	if (of_property_match_string(np, "nvmem-cell-names", "special") >= 0) {
+		ret = rockchip_get_efuse_value(np, "special", &value);
+		if (ret) {
+			dev_err(dev, "Failed to get soc special value\n");
+			goto out;
+		}
+		if (value == 0xc)
+			*bin = 0;
+		else
+			*bin = 1;
+	}
+
+	if (soc_is_rk3288w()) {
+		if (of_property_match_string(np, "nvmem-cell-names",
+					     "package") >= 0) {
+			ret = rockchip_get_efuse_value(np, "package", &value);
+			if (ret) {
+				dev_err(dev, "Failed to get soc package value\n");
+				goto out;
+			}
+			if (value == 0x2)
+				*bin = 0;
+		}
+	}
+
+	if (soc_is_rk3288w())
+		name = "performance-w";
+	else
+		name = "performance";
+
+	if (of_property_match_string(np, "nvmem-cell-names", name) >= 0) {
+		ret = rockchip_get_efuse_value(np, name, &value);
+		if (ret) {
+			dev_err(dev, "Failed to get soc performance value\n");
+			goto out;
+		}
+		if (value & 0x2)
+			*bin = 3;
+		else if (value & 0x01)
+			*bin = 2;
+	}
+	if (*bin >= 0)
+		dev_info(dev, "bin=%d\n", *bin);
+
+next:
+	if (!process)
+		goto out;
+	if (of_property_match_string(np, "nvmem-cell-names",
+				     "process") >= 0) {
+		ret = rockchip_get_efuse_value(np, "process", &value);
+		if (ret) {
+			dev_err(dev, "Failed to get soc process version\n");
+			goto out;
+		}
+		if (soc_is_rk3288() && (value == 0 || value == 1))
+			*process = 0;
+	}
+	if (*process >= 0)
+		dev_info(dev, "process=%d\n", *process);
+
+out:
+	return ret;
+}
+
 static const struct of_device_id rockchip_cpufreq_of_match[] = {
 	{
 		.compatible = "rockchip,px30",
 		.data = (void *)&px30_get_soc_info,
 	},
+	{
+		.compatible = "rockchip,rk3288",
+		.data = (void *)&rk3288_get_soc_info,
+	},
+	{
+		.compatible = "rockchip,rk3288w",
+		.data = (void *)&rk3288_get_soc_info,
+	},
 	{
 		.compatible = "rockchip,rk3326",
 		.data = (void *)&px30_get_soc_info,
-- 
2.17.1

