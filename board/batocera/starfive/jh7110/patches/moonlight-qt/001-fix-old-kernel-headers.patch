diff --git a/app/streaming/streamutils.cpp b/app/streaming/streamutils.cpp
index 649b517..8feb39d 100644
--- a/app/streaming/streamutils.cpp
+++ b/app/streaming/streamutils.cpp
@@ -23,14 +23,18 @@
 
 #if __has_include(<sys/hwprobe.h>)
 #include <sys/hwprobe.h>
-#else
+#define HAS_SYS_HWPROBE
+#endif
+
 #include <unistd.h>
+#include <sys/syscall.h>
 
 #if __has_include(<asm/hwprobe.h>)
 #include <asm/hwprobe.h>
-#include <sys/syscall.h>
-#else
-#define __NR_riscv_hwprobe 258
+#endif
+
+// Fallback for the hwprobe struct and key if headers are old
+#ifndef RISCV_HWPROBE_KEY_IMA_EXT_0
 struct riscv_hwprobe {
     int64_t key;
     uint64_t value;
@@ -38,25 +42,34 @@ struct riscv_hwprobe {
 #define RISCV_HWPROBE_KEY_IMA_EXT_0 4
 #endif
 
-// RISC-V Scalar AES [E]ncryption and [D]ecryption
+// Fallback for the syscall number
+#ifndef __NR_riscv_hwprobe
+#define __NR_riscv_hwprobe 258
+#endif
+
+// RISC-V Scalar AES [E]ncryption and [D]ecryption constants
 #ifndef RISCV_HWPROBE_EXT_ZKND
-#define RISCV_HWPROBE_EXT_ZKND (1 << 11)
-#define RISCV_HWPROBE_EXT_ZKNE (1 << 12)
+#define RISCV_HWPROBE_EXT_ZKND (1ULL << 11)
+#endif
+#ifndef RISCV_HWPROBE_EXT_ZKNE
+#define RISCV_HWPROBE_EXT_ZKNE (1ULL << 12)
 #endif
 
-// RISC-V Vector AES
+// RISC-V Vector AES constant
 #ifndef RISCV_HWPROBE_EXT_ZVKNED
-#define RISCV_HWPROBE_EXT_ZVKNED (1 << 21)
+#define RISCV_HWPROBE_EXT_ZVKNED (1ULL << 23)
 #endif
 
+// ONLY define this wrapper if it wasn't provided by <sys/hwprobe.h>
+#ifndef HAS_SYS_HWPROBE
 static int __riscv_hwprobe(struct riscv_hwprobe *pairs, size_t pair_count,
                            size_t cpu_count, unsigned long *cpus,
                            unsigned int flags)
 {
     return syscall(__NR_riscv_hwprobe, pairs, pair_count, cpu_count, cpus, flags);
 }
-
 #endif
+
 #endif
 #endif
 
@@ -305,4 +318,3 @@ bool StreamUtils::getNativeDesktopMode(int displayIndex, SDL_DisplayMode* mode,
 
     return true;
 }
-
