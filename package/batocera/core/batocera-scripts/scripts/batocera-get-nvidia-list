#!/bin/bash

# Bash script to get the latest Nvidia driver lists
# which may add new boards in between versions.

mkdir -p "/userdata/system/logs"
log="/userdata/system/logs/nvidia.log"

GITHUB_URL="https://raw.githubusercontent.com/batocera-linux/nvidia-lists/main/"
DEST_DIR="/userdata/system/.nvidia"

# Ensure the destination directory exists
mkdir -p "$DEST_DIR"

# Function to check internet connectivity using multiple methods
check_internet() {
    net="off"
    net1="off"
    net2="off"
    net3="off"

    # Check using curl
    case "$(curl -s --max-time 2 -I http://github.com | sed 's/^[^ ]*  *\([0-9]\).*/\1/; 1q')" in
      [23]) net1="on";;
      5) net1="off";;
      *) net1="off";;
    esac 

    # Check using ping
    ping -q -w 1 -c 1 github.com > /dev/null && net2="on" || net2="off"

    # Check using wget
    wget -q --spider http://github.com && if [ $? -eq 0 ]; then net3="on"; else net3="off"; fi

    # Determine overall network status
    if [[ "$net1" = "on" ]] || [[ "$net2" = "on" ]] || [[ "$net3" = "on" ]]; then
        net="on"
    fi 
}

# Check for an internet connection
check_internet

# Check if the download should be attempted
if [ "$net" = "on" ]; then
    # Download production.list
    wget -q --tries=5 --no-check-certificate --no-cache --no-cookies -O "$DEST_DIR/production.list" "${GITHUB_URL}production.list"
    if [ $? -eq 0 ]; then
        echo "Download of production.list successful. File saved to $DEST_DIR/production.list" >> "$log"
    else
        echo "Download of production.list failed." >> "$log"
    fi

    # Download legacy.list
    wget -q --tries=5 --no-check-certificate --no-cache --no-cookies -O "$DEST_DIR/legacy.list" "${GITHUB_URL}legacy.list"
    if [ $? -eq 0 ]; then
        echo "Download of legacy.list successful. File saved to $DEST_DIR/legacy.list" >> "$log"
    else
        echo "Download of legacy.list failed." >> "$log"
    fi

    # Download legacy390.list
    wget -q --tries=5 --no-check-certificate --no-cache --no-cookies -O "$DEST_DIR/legacy390.list" "${GITHUB_URL}legacy390.list"
    if [ $? -eq 0 ]; then
        echo "Download of legacy390.list successful. File saved to $DEST_DIR/legacy390.list" >> "$log"
    else
        echo "Download of legacy390.list failed." >> "$log"
    fi

    # Download legacy340.list
    wget -q --tries=5 --no-check-certificate --no-cache --no-cookies -O "$DEST_DIR/legacy340.list" "${GITHUB_URL}legacy340.list"
    if [ $? -eq 0 ]; then
        echo "Download of legacy340.list successful. File saved to $DEST_DIR/legacy340.list" >> "$log"
    else
        echo "Download of legacy340.list failed." >> "$log"
    fi
else
    echo "No internet connection detected, could not download Nvidia driver lists" >> "$log"
fi
