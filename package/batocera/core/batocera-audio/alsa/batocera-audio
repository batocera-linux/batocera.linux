#!/bin/sh

do_usage() {
	echo "$1 list"
	echo "$1 get"
	echo "$1 set {auto|custom|<device>}"
	echo "$1 test"
}	

do_select_audiodevice() {
	if echo "${MODE}" | grep -qE '^[0-9]*'; then
		SINK_ID="$(echo "$MODE" | sed -e"s/^\([0-9]*\).*/\1/")"
		pactl set-default-sink "${SINK_ID}"
	else
		# No valid device selected
		return 1
	fi
}

ACTION="$1"

case "${ACTION}" in
	list)
		printf '%s\n' auto custom
		# Pipewire detection
		#pw-cli ls Device | grep device.description | awk '$1 == "device.description" {gsub(/"/, "", $3); print NR-1 " " $3}'
		# PulseAudio detection
		pactl list short sinks | sed -e"s%\(^[0-9]*\)\s.*alsa_output.*output_\(\S*\)\s.*%\1 \2%"
		#pactl list sinks | grep alsa.long_card_name | awk '$1 == "alsa.long_card_name" {gsub(/"/, "", $3); print NR-1 " " $3}'
	;;

	get)
		/usr/bin/batocera-settings-get audio.device
	;;

	set)
		MODE="$2"
		case "${MODE}" in
			# auto: no .asoundrc
			# custom: don't touch .asoundrc
			# any other, create .asoundrc
			auto)
				# do nothing!
			;;

			custom)
				# do nothing!
			;;
			*)
				do_select_audiodevice
		esac
	;;

	test)
		aplay "/usr/share/sounds/Mallet.wav"
	;;
	*)
		do_usage $(basename $0)
esac
