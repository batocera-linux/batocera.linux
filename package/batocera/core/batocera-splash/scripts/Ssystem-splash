#!/bin/bash
## Use Framebuffer as picture overlay, you can see it if you load a ROM or shutdown ES

SPLASH_DIR=/userdata/splash/framebuffer
FM_IMAGE=".*\.\(jpg\|jpeg\|png\)"

do_filerandomize ()
{
    local array
    [[ -d "$SPLASH_DIR" ]] || return 1
    readarray -t array < <(find "$SPLASH_DIR" -regex "$1" -maxdepth 1 -type f)
    if [[ ${#array[@]} -gt 0 ]]; then
        echo "${array[$RANDOM % ${#array[@]}]}"
    fi
}

do_defaultimage ()
{
    image="/usr/share/batocera/splash/boot-logo-"$(batocera-resolution currentResolution)".png"
    if ! [[ -f "$image" ]]; then
        image="/usr/share/batocera/splash/boot-logo.png"
        [[ -f "$image" ]] || exit 1
    fi
}

do_start ()
{
    image=$(do_filerandomize "$FM_IMAGE")
    [[ -z "$image" ]] && do_defaultimage  
    test -e /dev/fb0 && fbv -f -e -i "${image}"
}

case "$1" in
    start)
    ES_FBPICTURE=$(/usr/bin/batocera-settings-get es.fbpicture.enabled)
    [ "${ES_FBPICTURE}" = "1" ] && do_start &
        ;;
    stop)
        ;;
    *)
esac

exit $?
