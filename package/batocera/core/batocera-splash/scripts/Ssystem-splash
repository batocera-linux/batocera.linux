#!/bin/sh

# This is the BATOCERA system splash service
# It shows the unique BATOCERA logo in early boot stage

do_start ()
{
    # For special times of the year.
    SEASON=
    # Valentine's day
    [ $(date +%m%d) -eq 214 ] && SEASON=valentine
    # April Fools!
    [ $(date +%m%d) -eq 41 ] && SEASON=aprilfool
    # Batocera's anniversary.
    [ $(date +%m%d) -eq 621 ] && SEASON=anniversary
    # All Hallows' evening.
    [ $(date +%m%d) -eq 1031 ] && SEASON=halloween
    # Christmas time! Only true if month is December and date is less than 27.
    [ $(date +%m) -eq 12 -a $(date +%d) -lt 27 ] && SEASON=xmas

	# Check if it's a seasonal time of the year.
	if [ -n "$SEASON" ]; then
		image="/usr/share/batocera/splash/boot-logo-${SEASON}-$(batocera-resolution currentResolution).png"
		# If a specialized resolution of this image doesn't exist, use the regular res.
		[ -f "$image" ] || image="/usr/share/batocera/splash/boot-logo-${SEASON}.png"
    else
        # Apply the default boot logo at the appropriate resolution.
        image="/usr/share/batocera/splash/boot-logo-"$(batocera-resolution currentResolution)".png"
	fi

    if ! [ -f "$image" ]; then
        # If the image doesn't exist, use the basic logo.
        image="/usr/share/batocera/splash/boot-logo.png"
        # If that also doesn't exist for some reason, exit indicating an error.
        [ -f "$image" ] || exit 1
    fi

    # Here is the code that will eventually use the custom splash image for ES
    # blah blah blah
    #if $xmas; then
    #    cp /usr/share/batocera/splash/boot-logo-xmas.png /usr/share/emulationstation/resources/logo.png
    #fi

    # on some sytems, fb0 is not immediatly loaded, so, keep a chance by waiting a bit
    N=0
    while ! test -e /dev/fb0 -o $N -gt 80
    do
        sleep 0.25
        N=$((N+1))
    done
    test -e /dev/fb0 && fbv -f -e -i "${image}"
}

case "$1" in
    start)
        do_start &
        ;;
    stop)
        ;;
    *)
esac

exit $?
