#!/bin/sh

# This is the BATOCERA system splash service
# It shows the unique BATOCERA logo in early boot stage

BOOTCONF="/boot/batocera-boot.conf"

# Not called if user has set seasonal-splashes to false.
seasonal ()
{
    # Refer to /lol/ for the table of seasons.
    MONTH=$(date +%m)
    DAY=$(date +%d)

    SEASON=
    case $MONTH in
        1)
            # Happy New Year!
            (( $DAY == 1 )) && SEASON=newyear
            ;;
        2)
            # Valentine's day
            (( $DAY == 14 )) && SEASON=valentine
            ;;
        3)
            # Pi Day
            if (( $DAY == 14 )); then SEASON=pi
            # Saint Patrick's day
            elif (( $DAY == 17 )); then SEASON=stpatrick
            fi
            ;;
        4)
            # April Fools!
            (( $DAY == 1 )) && SEASON=aprilfool
            ;;
        6)
            # Aurora Borealis
            if (( $DAY > 6 && $DAY < 18 )); then SEASON=steamedhams
            # Batocera's anniversary.
            elif (( $DAY == 21 )); then SEASON=anniversary
            fi
            ;;
        7)
            # Independence day
            (( $DAY == 4 )) && SEASON=independence
            ;;
        9)
            # Aurora Australis
            if (( $DAY > 6 && $DAY < 18 )); then SEASON=australis
            # International Talk Like a Pirate Day
            elif (( $DAY == 19 )); then SEASON=pirate
            fi
            ;;
        10)
            # All Hallows' evening.
            (( $DAY == 31 )) && SEASON=halloween
            ;;
        12)
            # Christmas time! Only true if month is December and date is less than 27.
            (( $DAY < 27 )) && SEASON=xmas
            # Monkey day https://en.wikipedia.org/wiki/Monkey_Day
            if (( $DAY == 14 )); then SEASON=monkey
            # Winter solstice
            elif (( $DAY == 21 || $DAY == 22 )); then SEASON=solstice
            fi
            ;;
    esac
}

do_start ()
{
    if ! grep -qE '^[ ]*seasonal-splashes[ ]*=[ ]*false[ ]*$' "${BOOTCONF}"; then
        seasonal
    fi

	# Check if it's a seasonal time of the year.
	if [ -n "$SEASON" ]; then
		image="/usr/share/batocera/splash/boot-logo-${SEASON}-$(batocera-resolution currentResolution).png"
		# If a specialized resolution of this image doesn't exist, use the regular res.
		[ -f "$image" ] || image="/usr/share/batocera/splash/boot-logo-${SEASON}.png"
    else
        # Apply the default boot logo at the appropriate resolution.
        image="/usr/share/batocera/splash/boot-logo-"$(batocera-resolution currentResolution)".png"
	fi

    if ! [ -f "$image" ]; then
        # If the image doesn't exist, use the basic logo.
        image="/usr/share/batocera/splash/boot-logo.png"
        # If that also doesn't exist for some reason, exit indicating an error.
        [ -f "$image" ] || exit 1
    fi

    # Here is the code that will eventually use the custom splash image for ES
    # blah blah blah
    #if $xmas; then
    #    cp /usr/share/batocera/splash/boot-logo-xmas.png /usr/share/emulationstation/resources/logo.png
    #fi

    # on some sytems, fb0 is not immediatly loaded, so, keep a chance by waiting a bit
    N=0
    while ! test -e /dev/fb0 -o $N -gt 80
    do
        sleep 0.25
        N=$((N+1))
    done
    test -e /dev/fb0 && fbv -f -e -i "${image}"
}

case "$1" in
    start)
        do_start &
        ;;
    stop)
        ;;
    *)
esac

exit $?
