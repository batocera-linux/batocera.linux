#!/bin/bash

NAME="S92switch"
RUN="/usr/bin/rpi_gpioswitch"
BTD_PID=$(ps -eo pid,args | grep "/bin/bash $RUN" | grep -v grep | awk '{print $1}')

#Add new devices here and modify /usr/bin/rpi_gpioswitch, too
devices=(
         ATX_RASPI_R2_6
         REMOTEPIBOARD_2003
         REMOTEPIBOARD_2005
         MAUSBERRY
         WITTYPI
         ONOFFSHIM
         RETROFLAG
         PIN56ONOFF
         PIN56PUSH
         PIN356ONOFFRESET
        )

# Carry out specific functions when asked to by the system
case "$1" in
    start)
        systemsetting="python /usr/lib/python2.7/site-packages/configgen/settings/batoceraSettings.py"
        powerswitch="`$systemsetting  -command load -key system.power.switch`"
        for i in ${devices[@]}; do
            [ "$i" == "$powerswitch" ] && break
        done
        if [ $? -eq 0 ]; then
            nice -n 19 $RUN start $powerswitch &
        fi
    ;;
    stop)
        systemsetting="python /usr/lib/python2.7/site-packages/configgen/settings/batoceraSettings.py"
        powerswitch="`$systemsetting  -command load -key system.power.switch`"
        if [ ! -z "$BTD_PID" ]; then
            kill $BTD_PID
            $RUN stop $powerswitch
        elif test -e "/tmp/poweroff.please"; then
            $RUN stop $powerswitch
        fi
    ;;
    status)
        if [ ! -z "$BTD_PID" ]; then
            echo "Service rpi_gpioswitch ["$BTD_PID"] [ OK ]"
        else
            echo "Service rpi_gpioswitch [ KO ]"
        fi
    ;;
    setup)
        rpi_gpioswitch
    ;;
    *)
        echo "Usage: /etc/init.d/S92switch {start | stop | status | setup}"
        exit 1
    ;;
esac

exit 0
