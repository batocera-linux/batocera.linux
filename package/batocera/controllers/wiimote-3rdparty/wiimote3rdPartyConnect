#!/bin/bash

ITIMEOUT=$1
test -z "${ITIMEOUT}" && ITIMEOUT=30

HCIDEV=$(hcitool dev | cut -f 2,3 | grep -E '^hci0.([A-F0-9]{2}:){5}[A-F0-9]{2}$' | cut -f 2)

if test -z "${HCIDEV}"
then
    echo "no hci0 dev found" >&2
    exit 1
fi

echo "Press sync button on a 3rd party wiimote..." >&2
if ! hcitool inq --length="${ITIMEOUT}" --iac=liac | cut -f 2 | grep -E '^([A-F0-9]{2}:){5}[A-F0-9]{2}$' |
	while read ADDR
	do
	    # create the files
	    mkdir -p "/var/lib/bluetooth/${HCIDEV}/${ADDR}" || exit 1
	    mkdir -p "/var/lib/bluetooth/${HCIDEV}/cache"   || exit 1

	    echo "
[General]
Name=Nintendo RVL-CNT-01
Class=0x002504
SupportedTechnologies=BR/EDR;
Trusted=true
Blocked=false
WakeAllowed=true
Services=00001000-0000-1000-8000-00805f9b34fb;00001124-0000-1000-8000-00805f9b34fb;00001200-0000-1000-8000-00805f9b34fb;

[DeviceID]
Source=2
Vendor=1406
Product=774
Version=1536
" > "/var/lib/bluetooth/${HCIDEV}/${ADDR}/info" || exit 1

	    echo "
[General]
Name=Nintendo RVL-CNT-01

[ServiceRecords]
0x00010000=3601CC0900000A000100000900013503191124090004350D350619010009001135031900110900053503191002090006350909656E09006A0901000900093508350619112409010009000D350F350D3506190100090013350319001109010025134E696E74656E646F2052564C2D434E542D303109010125134E696E74656E646F2052564C2D434E542D303109010225084E696E74656E646F090200090100090201090111090202080409020308330902042800090205280109020635DF35DD082225D905010905A1018510150026FF00750895010600FF09019100851195010901910085129502090191008513950109019100851495010901910085159501090191008516951509019100851795060901910085189515090191008519950109019100851A950109019100852095060901810085219515090181008522950409018100853095020901810085319505090181008532950A0901810085339511090181008534951509018100853595150901810085369515090181008537951509018100853D951509018100853E951509018100853F951509018100C0090207350835060904090901000902082800090209280109020A280109020B09010009020C090C8009020D280009020E2800
" > "/var/lib/bluetooth/${HCIDEV}/cache/${ADDR}" || exit 1

	    if ! bluetoothctl connect "${ADDR}"
	    then
		echo "connexion failed" >&2
		exit 1
	    fi
	done
then
    echo "failed" >&2
    exit 1
fi

exit 0
