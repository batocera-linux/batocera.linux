#!/bin/sh

. /etc/profile.d/25-language.sh

# Add the keyboard details to the environment variable
LABWC_ENV_FILE="/userdata/system/.config/labwc/environment"
echo "XKB_DEFAULT_LAYOUT=$XKB_DEFAULT_LAYOUT" > "$LABWC_ENV_FILE"
echo "XKB_DEFAULT_VARIANT=$XKB_DEFAULT_VARIANT" >> "$LABWC_ENV_FILE"

# Allow startup from a user session where WAYLAND_DISPLAY is set,
# e.g. to restart via /etc/init.d/S31emulationstation start
unset WAYLAND_DISPLAY

# Log and configuration file paths
LOG_FILE="/userdata/system/logs/display.log"
LABWC_CONF_DIR="/userdata/system/.config/labwc"
LABWC_LOG_FILE="/var/log/labwc.log"

mkdir -p /userdata/system/logs
mkdir -p /var/run
mkdir -p /var/log

# GPU Selection Logic
PRIME_PCI_ID=""

# Check which Prime GPU was detected by the startup script
if [ -f "/var/tmp/nvidia.prime" ]; then
    PRIME_PCI_ID=$(cat /var/tmp/nvidia.prime)
elif [ -f "/var/tmp/amd.prime" ]; then
    PRIME_PCI_ID=$(cat /var/tmp/amd.prime)
elif [ -f "/var/tmp/intel.prime" ]; then
    PRIME_PCI_ID=$(cat /var/tmp/intel.prime)
fi

# If a Prime GPU was identified, we must find its /dev/dri/cardX path
if [ -n "$PRIME_PCI_ID" ]; then
    # Convert "pci-0000_03_00_0" back to "0000:03:00.0" for sysfs matching
    SYSFS_ID=$(echo "$PRIME_PCI_ID" | sed -e 's/^pci-//' -e 's/_/:/g' -e 's/:/./3')

    # Find which card matches this PCI ID
    for card in /sys/class/drm/card*; do
        # Check if the device link points to our PCI ID
        if readlink -f "$card/device" | grep -q "$SYSFS_ID"; then
            CARD_NAME=$(basename "$card")
            export WLR_DRM_DEVICES="/dev/dri/$CARD_NAME"
            echo "Forcing Primary GPU: $WLR_DRM_DEVICES ($SYSFS_ID)" >> "$LOG_FILE"
            break
        fi
    done
fi

# Start Labwc with specified environment variable, logging output
echo "Starting Labwc with keyboard layout: $XKB_DEFAULT_LAYOUT" >> "$LOG_FILE"

WLR_LIBINPUT_NO_DEVICES=1 /usr/bin/labwc -d -C $LABWC_CONF_DIR > "$LABWC_LOG_FILE" 2>&1
