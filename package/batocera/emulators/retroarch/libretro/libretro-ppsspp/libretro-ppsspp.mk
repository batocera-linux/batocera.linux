################################################################################
#
# LIBRETRO PPSSPP
#
################################################################################
# Version.: Commits on Jul 12, 2020
LIBRETRO_PPSSPP_VERSION = v1.10.3
LIBRETRO_PPSSPP_SITE = https://github.com/hrydgard/ppsspp.git
LIBRETRO_PPSSPP_SITE_METHOD=git
LIBRETRO_PPSSPP_GIT_SUBMODULES=YES
LIBRETRO_PPSSPP_DEPENDENCIES = ffmpeg
LIBRETRO_PPSSPP_LICENSE = GPLv2

LIBRETRO_PPSSPP_PLATFORM = $(LIBRETRO_PLATFORM)

LIBRETRO_PPSSPP_CONF_OPTS  = -DLIBRETRO=ON
LIBRETRO_PPSSPP_CONF_OPTS += -DCMAKE_BUILD_TYPE=Release
LIBRETRO_PPSSPP_CONF_OPTS += -DUSE_FFMPEG=ON
LIBRETRO_PPSSPP_CONF_OPTS += -DUSING_FBDEV=ON

# arm
ifeq ($(BR2_arm),y)
	LIBRETRO_PPSSPP_PLATFORM = armv 
	LIBRETRO_PPSSPP_CONF_OPTS += -DUSING_GLES2=ON
	LIBRETRO_PPSSPP_CONF_OPTS += -DUSING_X11_VULKAN=OFF
endif

ifeq ($(BR2_aarch64),y)
	LIBRETRO_PPSSPP_PLATFORM = arm64
	LIBRETRO_PPSSPP_CONF_OPTS += -DARM64=ON 
	LIBRETRO_PPSSPP_CONF_OPTS += -DUSING_GLES2=ON
	LIBRETRO_PPSSPP_CONF_OPTS += -DUSING_X11_VULKAN=OFF
endif

# x86
ifeq ($(BR2_PACKAGE_BATOCERA_TARGET_X86),y)
	LIBRETRO_PPSSPP_TARGET_ARCH = TARGET_ARCH=86 
endif

# x86_64
ifeq ($(BR2_PACKAGE_BATOCERA_TARGET_X86_64),y)
	LIBRETRO_PPSSPP_TARGET_ARCH = TARGET_ARCH=64
endif

# rpi3
ifeq ($(BR2_PACKAGE_BATOCERA_TARGET_RPI3),y)
	LIBRETRO_PPSSPP_PLATFORM = rpi
endif

define LIBRETRO_PPSSPP_BUILD_CMDS
	$(TARGET_CONFIGURE_OPTS) $(MAKE) CXX="$(TARGET_CXX)" CC="$(TARGET_CC)" -C $(@D)/libretro -f Makefile \
		platform="$(LIBRETRO_PPSSPP_PLATFORM)" $(LIBRETRO_PPSSPP_TARGET_ARCH)
endef

define LIBRETRO_PPSSPP_INSTALL_TARGET_CMDS
	$(INSTALL) -D $(@D)/lib/ppsspp_libretro.so \
		$(TARGET_DIR)/usr/lib/libretro/ppsspp_libretro.so
endef

$(eval $(cmake-package))
